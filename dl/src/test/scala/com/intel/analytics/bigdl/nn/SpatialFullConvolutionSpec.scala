/*
 * Licensed to Intel Corporation under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * Intel Corporation licenses this file to You under the Apache License, Version 2.0
 * (the "License"); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.intel.analytics.bigdl.nn

import com.intel.analytics.bigdl.tensor.{Storage, Tensor}
import org.scalatest.{FlatSpec, Matchers}

import scala.util.Random

class SpatialFullConvolutionSpec extends FlatSpec with Matchers {

  "A SpatialFullConvolution BilinearFiller" should "generate correct parameter" in {
    val conv = new SpatialFullConvolution[Tensor[Double], Double](3, 6, 3, 3, 2, 2,
      0, 0, 0, 0, 1, false, BilinearFiller)

    val caffeWeight = Tensor(Storage(Array(
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625,
      0.0625, 0.1875, 0.1875, 0.1875, 0.5625, 0.5625, 0.1875, 0.5625, 0.5625
    )), 1, Array(1, 3, 6, 3, 3))

    conv.weight should be(caffeWeight)
  }

  "A SpatialFullConvolution BilinearFiller(1, 2, 4, 4)" should "generate correct parameter" in {
    val conv = new SpatialFullConvolution[Tensor[Double], Double](1, 2, 4, 4, 2, 2,
      0, 0, 0, 0, 1, false, BilinearFiller)

    val caffeWeight = Tensor(Storage(Array(
      0.0625, 0.1875, 0.1875, 0.0625,
      0.1875, 0.5625, 0.5625, 0.1875,
      0.1875, 0.5625, 0.5625, 0.1875,
      0.0625, 0.1875, 0.1875, 0.0625,

      0.0625, 0.1875, 0.1875, 0.0625,
      0.1875, 0.5625, 0.5625, 0.1875,
      0.1875, 0.5625, 0.5625, 0.1875,
      0.0625, 0.1875, 0.1875, 0.0625
    )), 1, Array(1, 1, 2, 4, 4))

    conv.weight should be(caffeWeight)
  }

  "A SpatialFullConvolution BilinearFiller" should "generate correct output" in {
    val conv = new SpatialFullConvolution[Tensor[Double], Double](10, 10, 4, 4, 2, 2,
      1, 1, 0, 0, 10, false, BilinearFiller)

    val input = Tensor[Double](1, 10, 20, 30).apply1(e => Random.nextDouble())
    val output = conv.updateOutput(input).toTensor[Double]

    println(output)
  }

  "A SpatialFullConvolution " should "generate correct output" in {
    val conv = new SpatialFullConvolution[Tensor[Double], Double](4, 4, 4, 4, 2, 2,
      1, 1, 0, 0, 4, false, BilinearFiller)
    val input = Tensor(Storage(Array(-1.2062726021, 1.1360136271, -0.5822637081, -0.4884754717,
      -0.4828263223, 1.4208023548, 0.2508232594, -1.0723319054,
      0.9935934544, -1.6415252686, -0.9477695823, 2.0529758930,
      0.4161689579, -1.8054876328, -0.1555761546, -0.7323240638,
      -0.4121989012, 0.4926592410, 0.8218865395, 1.3562762737,
      -0.0761539638, 0.8350052238, 0.0170968231, 0.2041981220,
      -0.1073418930, 0.5806275010, -1.0908919573, 0.2071549445,
      -1.5484724045, -0.3902291358, 0.0674262643, -1.0561497211,
      -1.4614270926, -2.1162011623, -1.2234330177, 0.9130580425,
      -0.1511989385, -1.1195218563, -0.8401300907, 0.7589672804,
      -0.1791657358, 0.5785090923, 0.3735814393, -0.0918579102,
      0.8041715622, -1.2976150513, -0.0350162163, -0.7250366211,
      -0.9356633425, 0.2049966156, 1.2573252916, -1.4931064844,
      -0.2313361019, -0.2042944878, -0.8342237473, -0.9390826821,
      -1.0254511833, -1.8914625645, 1.4330552816, 1.4577983618,
      -0.8884611726, -0.8923560977, 1.1033450365, -0.3076076508,
      0.1991681159, -0.5040659904, 0.9498041868, -0.0322302803,
      0.6818747520, 0.7700155377, 0.0597986951, -0.6497900486,
      -1.1513022184, 0.3796474338, 0.3906872869, 2.0950577259,
      -0.4527992308, -0.5072858930, 0.1653355509, 0.4129824936,
      0.1695163697, 1.0566691160, 1.6450278759, 2.3477141857,
      0.6952699423, 1.0488075018, 2.3405942917, -2.9431235790,
      -0.2799325287, 0.3436079025, -1.4555948973, -0.7950132489,
      0.4335360229, 0.1701952070, -0.4905709922, 0.9766649008,
      0.9402820468, -1.3368971348, -0.8464720845, 0.9635215402,
      0.8822785020, 0.1649760902, 1.0217674971, -2.0308346748,
      -0.9131824374, -1.8492782116, 1.0612061024, -0.6403536797,
      2.4697945118, -0.0608077310, 1.1563122272, 0.1171465740,
      0.1204565838, -1.1049138308, -0.9108580947, 0.9660868645,
      -0.0233467966, 0.6739346385, 0.1974892318, 0.1450853497))).resize(1, 4, 5, 6)

    val expectedOutput = Tensor(Storage(Array(
      -0.6785283089, -0.4655257463, 0.4128315747, 0.5298332572,
      -0.1145207882, -0.4191125035, -0.3839418888, -0.3652973771,
      -0.3631789684, -0.0051893592, 0.7086713910, 0.7992013097,
      -0.6314989328, -0.4855171442, 0.2274458110, 0.3908706009,
      0.0047572404, -0.3354090452, -0.6296283007, -0.7323189974,
      -0.6434810758, -0.0545851588, 1.0343687534, 1.1841342449,
      -0.0850880295, -0.2151494026, -0.4185468256, -0.2402768731,
      0.3196604848, 0.1114061475, -0.8650398254, -1.2228305340,
      -0.9619660378, -0.1499171853, 1.2133159637, 1.4211994410,
      0.2191197574, -0.0947854370, -0.8686757088, -0.7651404142,
      0.2158205807, 0.1761695147, -0.8840934634, -1.2641379833,
      -0.9639639258, -0.1946834922, 1.0437033176, 1.2471725941,
      0.2811244130, -0.1244252771, -1.1229408979, -1.1837199926,
      -0.3067625165, -0.1411188990, -0.6867892146, -0.8562411666,
      -0.6494747400, -0.1888840795, 0.5255309343, 0.6620538235,
      0.3881987631, 0.1344370991, -0.6318855286, -0.7952152491,
      -0.3555521071, -0.1869133860, -0.2892989516, -0.3315875530,
      -0.3137791753, -0.1235202402, 0.2391892374, 0.3154079914,
      0.5403428674, 0.6818016171, 0.6044907570, 0.4003741145,
      0.0694516748, 0.0387860835, 0.3083772957, 0.3098229170,
      0.0431228839, 0.0014080182, 0.1846782863, 0.2072350532,
      0.4421845675, 0.7327755690, 1.0191679001, 0.7893134356,
      0.0432121456, -0.0778681934, 0.4260723889, 0.4149581194,
      -0.1112109572, -0.2668237686, -0.0518803932, 0.0416934788,
      0.0937239081, 0.2873588204, 0.6121460199, 0.3716028929,
      -0.4342706800, -0.5368762612, 0.0637862608, -0.0161818862,
      -0.7767807245, -0.9282156825, -0.4704867303, -0.1812167466,
      -0.0603798144, 0.0484878458, 0.3064763546, 0.1220607162,
      -0.5047590733, -0.5747851729, -0.0880175903, -0.1738139093,
      -0.8321741819, -0.9441837072, -0.5098424554, -0.2195038944,
      0.0379272737, -0.1601008028, -0.5814417601, -0.8681017756,
      -1.0200808048, -1.2188403606, -1.4643807411, -1.4197568893,
      -1.0849688053, -0.5169826746, 0.2842014730, 0.5135951638,
      0.0095774718, -0.2584207058, -0.8008020520, -1.1305203438,
      -1.2475752831, -1.3289294243, -1.3745825291, -1.2886483669,
      -1.0711269379, -0.5144194365, 0.3814740479, 0.6220656037,
      -0.0724069774, -0.3483267128, -0.8518947959, -1.0766227245,
      -1.0225104094, -0.7365469337, -0.2187322080, -0.0799267292,
      -0.3201306462, -0.1646378338, 0.3865516484, 0.4966097474,
      -0.0150028840, -0.2306543440, -0.6519553661, -0.7542181015,
      -0.5374424458, -0.2605855763, 0.0763526112, 0.1478341818,
      -0.0461408496, -0.0441906005, 0.1536849141, 0.1894670129,
      0.1817897558, 0.0945962816, -0.2009838223, -0.1633063853,
      0.2076286227, 0.0989547521, -0.4893280864, -0.6053655148,
      -0.2491575480, -0.1530777514, -0.3171260357, -0.2993626595,
      0.0347026736, 0.0302916020, -0.0016656443, 0.2161318064,
      0.6836839318, 0.3514730334, -0.7805009484, -1.0308899879,
      -0.3996941149, -0.2117849141, -0.4671623707, -0.4461383224,
      -0.4562641084, -0.4235683680, -0.0540008098, 0.3840964437,
      0.8907234073, 0.4969692230, -0.7971660495, -1.1287392378,
      -0.4977504909, -0.2203120887, -0.2964240313, -0.2508600056,
      -0.6827275753, -0.7029833794, -0.2883432806, 0.1108903885,
      0.4947175682, 0.1167994738, -1.0228638649, -1.1483311653,
      -0.2596025765, 0.1913784891, 0.2046119869, 0.1584215462,
      -0.6446877718, -0.8079534769, -0.7046930194, -0.6034863591,
      -0.5043335557, -0.7890361547, -1.4575942755, -1.0896657705,
      0.3147496581, 1.0232869387, 1.0359456539, 0.7817063332,
      -0.4692508578, -0.6453288794, -0.6846509576, -0.7205060720,
      -0.7528943419, -0.9314655662, -1.2562197447, -0.7952498198,
      0.4514443278, 1.0794308186, 1.0887093544, 0.8200115561,
      -0.4997594059, -0.6670761704, -0.6685367823, -0.2950731218,
      0.4533148110, 0.5629551411, 0.0338478982, -0.1356852800,
      0.0543556288, 0.0175196901, -0.2461930960, -0.2835371196,
      -0.3216711283, -0.4910022914, -0.6152172089, -0.2584991455,
      0.5791518688, 0.7389326096, 0.2208429873, 0.0124300569,
      0.1136938632, -0.0118799284, -0.3642913103, -0.4053727388,
      0.3676784039, 0.3058629632, -0.0628868341, 0.0113642812,
      0.5286163688, 0.7155841589, 0.5722678900, 0.3991175890,
      0.1961332262, -0.0823589712, -0.4363589883, -0.4600192606,
      0.3183957040, 0.3360804915, 0.1591862440, 0.2053238302,
      0.4744932353, 0.7321274281, 0.9782265425, 0.8088693619,
      0.2240559310, -0.2048040926, -0.4777106941, -0.4606229961,
      -0.4695192277, -0.4003497660, 0.0510021113, 0.3233795762,
      0.4167825878, 0.7885624170, 1.4387190342, 1.2416855097,
      0.1974620074, -0.3792152703, -0.4883464277, -0.4071839452,
      -0.6166070700, -0.5196117759, 0.0854502022, 0.3748345375,
      0.3485412002, 0.7104110718, 1.4604440928, 1.3945097923,
      0.5126082897, 0.1053591967, 0.1727624685, 0.1548480690,
      -0.1228679121, -0.0217057317, 0.2625305653, 0.3596888185,
      0.2697690129, 0.4976733923, 1.0434020758, 1.2673425674,
      1.1694948673, 1.2489192486, 1.5056158304, 1.2254730463,
      0.2233643532, 0.3663490415, 0.5034088492, 0.6070255041,
      0.6771990657, 0.5483946204, 0.2206121981, 0.3334876299,
      0.8870210648, 1.3345127106, 1.6759625673, 1.3850157261,
      0.4220897555, 0.6445526481, 0.8080850244, 1.1168445349,
      1.5708315372, 0.8625748158, -1.0079252720, -1.4070546627,
      -0.3348131776, 0.3621392846, 0.6838027835, 0.6334758401,
      0.3910893500, 0.5877407789, 0.7203173041, 1.0288156271,
      1.5132358074, 0.7647486925, -1.2166454792, -1.7079943419,
      -0.7092977166, -0.0930355638, 0.1407921016, 0.1932794452,
      -0.8187721372, -0.9678370953, -0.7201189995, -0.3659069538,
      0.0947990268, 0.2757756114, 0.1770228148, 0.0037527457,
      -0.2440345734, -0.0928215086, 0.4573919177, 0.5493739843,
      -0.6424692869, -0.8750903010, -0.9120196104, -0.6694797277,
      -0.1474705637, 0.1772821844, 0.3047786057, 0.2395554483,
      -0.0183872543, 0.0829167068, 0.5434673429, 0.5803070068,
      0.2559846342, -0.0443719178, -0.8157414198, -1.0326871872,
      -0.6952091455, -0.2035550475, 0.4422749579, 0.7086589932,
      0.5955970883, 0.4962741137, 0.4106902480, 0.2759237289,
      0.7204900980, 0.3428946733, -0.8926227093, -1.3485735655,
      -1.0249576569, -0.5822818279, -0.0205461979, 0.4269937873,
      0.7603382468, 0.6861687303, 0.2044853419, -0.0272672623,
      0.7510471344, 0.2867095470, -1.1426635981, -1.6171388626,
      -1.1367162466, -0.9588981867, -1.0836849213, -0.6054400802,
      0.4758360684, 0.6526003480, -0.0751473755, -0.3292659223,
      1.0378307104, 0.6532487273, -0.8078023195, -1.2526980639,
      -0.6814385653, -0.6362745762, -1.1172062159, -0.8117492795,
      0.2800960541, 0.4303905964, -0.3608655930, -0.5673702955,
      1.5808408260, 1.4425122738, 0.1119610891, -0.2552512288,
      0.3408752680, 0.3855889738, -0.1211100668, -0.1919337213,
      0.1731180698, 0.0195395201, -0.6526693702, -0.7415803671,
      1.2184735537, 1.2674525976, 0.5530948043, 0.3622862697,
      0.6950270534, 0.7101339698, 0.4076070786, 0.2271863818,
      0.1688719541, -0.0933174491, -0.5593818426, -0.5943105221,
      -0.0492711663, 0.1280696392, 0.5155987144, 0.5999143720,
      0.3810167611, 0.3373603821, 0.4689452052, 0.4456110001,
      0.2673577070, 0.0918196887, -0.0810030773, -0.1255608499,
      -0.5123576522, -0.3312163651, 0.3726379871, 0.5390463471,
      0.1680087149, 0.1132301688, 0.3747107089, 0.4161174595,
      0.2374504358, 0.1382911950, 0.1186397374, 0.0816105083))).resize(1, 4, 10, 12)

    val gradOutput = Tensor(Storage(Array(
      0.5507978797, 0.7081478238, 0.2909047306, 0.5108276010,
      0.8929469585, 0.8962931037, 0.1255853176, 0.2072428763,
      0.0514672026, 0.4408098459, 0.0298762117, 0.4568332136,
      0.6491440535, 0.2784872949, 0.6762549281, 0.5908628106,
      0.0239818823, 0.5588541031, 0.2592524588, 0.4151012003,
      0.2835250795, 0.6931379437, 0.4404537082, 0.1568677425,
      0.5446490049, 0.7803147435, 0.3063635230, 0.2219578773,
      0.3879712522, 0.9363836646, 0.9759954214, 0.6723836660,
      0.9028341174, 0.8457508683, 0.3779940307, 0.0922170058,
      0.6534109116, 0.5578407645, 0.3615647554, 0.2250545025,
      0.4065199196, 0.4689402580, 0.2692355812, 0.2917927802,
      0.4576863945, 0.8605338931, 0.5862529278, 0.2834878564,
      0.2779774964, 0.4546220899, 0.2054103464, 0.2013787180,
      0.5140350461, 0.0872293711, 0.4835855365, 0.3621762097,
      0.7076866031, 0.7467462420, 0.6910929084, 0.6891804338,
      0.3736001253, 0.6681348085, 0.3398486674, 0.5727938414,
      0.3258071542, 0.4451450408, 0.0615289323, 0.2426754236,
      0.9716026187, 0.2305842042, 0.6914775372, 0.6504768729,
      0.7239391208, 0.4750885963, 0.5966637731, 0.0669694245,
      0.0725621358, 0.1989760250, 0.1518609971, 0.1001043469,
      0.1292938590, 0.5532777309, 0.1878148317, 0.9521012306,
      0.6816117764, 0.5410196781, 0.7071806192, 0.2638866603,
      0.9267256856, 0.8391930461, 0.7263194919, 0.4802399576,
      0.8421031833, 0.7447523475, 0.6603258848, 0.9139752388,
      0.6336655617, 0.3659405708, 0.5528445840, 0.1963805705,
      0.1920723021, 0.7256696224, 0.7849367261, 0.9720983505,
      0.8509714007, 0.5435943007, 0.0897908732, 0.4888732433,
      0.9279363751, 0.7876182199, 0.4850942194, 0.4552793503,
      0.2179857641, 0.1772133857, 0.0736236721, 0.8923931718,
      0.6401765943, 0.1433323175, 0.4141269326, 0.0491089262,
      0.2093733549, 0.7307081223, 0.6511227489, 0.4789783061,
      0.2747805119, 0.6522231102, 0.9564495087, 0.4355205595,
      0.0701325014, 0.0577314869, 0.0828710198, 0.9597072005,
      0.5407608151, 0.8374624252, 0.1700335443, 0.2603450716,
      0.6919775009, 0.8955703378, 0.3406884968, 0.0646732002,
      0.8641196489, 0.2908724546, 0.7410824299, 0.1580336541,
      0.6949634552, 0.8414196372, 0.7271520495, 0.3591075242,
      0.7266897559, 0.1394671202, 0.3138191104, 0.4195827544,
      0.8772120476, 0.1537402123, 0.8801248074, 0.7989643216,
      0.9716243148, 0.3677029908, 0.2049397677, 0.2405703217,
      0.8278627992, 0.9652281404, 0.6988099813, 0.4824970365,
      0.2870497704, 0.8336879015, 0.8721795082, 0.0921315923,
      0.2159494758, 0.8317610621, 0.8483039141, 0.3146530092,
      0.2792946100, 0.4308150113, 0.5394464731, 0.0955668166,
      0.8369121552, 0.5347348452, 0.7749677896, 0.2308362722,
      0.9652933478, 0.7510272861, 0.3430938721, 0.9485276341,
      0.7005117536, 0.8405610919, 0.0454973057, 0.0556415394,
      0.7427372932, 0.3046864271, 0.5167843699, 0.1562624276,
      0.9779524207, 0.5027510524, 0.8290010691, 0.0740377977,
      0.4789154530, 0.0622794814, 0.8842414021, 0.4458101690,
      0.0685499161, 0.0764962807, 0.5387926698, 0.0755664036,
      0.1837723106, 0.4363570809, 0.4977828264, 0.5833119154,
      0.6205126643, 0.3728114963, 0.6187365651, 0.1572446525,
      0.2755084634, 0.7987182736, 0.1530892998, 0.2233229727,
      0.2429781854, 0.4795072973, 0.0007455220, 0.0303113610,
      0.4615481496, 0.1625206918, 0.6795018315, 0.7952045798,
      0.5781633854, 0.6947649717, 0.3909580112, 0.0462962016,
      0.4394215345, 0.3719803095, 0.5970032215, 0.1342181712,
      0.2277128994, 0.8147824407, 0.2643255293, 0.4103201926,
      0.9359721541, 0.2755524516, 0.1452899575, 0.7020201087,
      0.5670665503, 0.6115938425, 0.0420308523, 0.4172669053,
      0.0042664343, 0.2465354651, 0.7060561776, 0.0615407154,
      0.2946934998, 0.9881127477, 0.9712222219, 0.4818463922,
      0.7356933951, 0.6326557994, 0.4656930566, 0.8570664525,
      0.1725182533, 0.8284319043, 0.0420695245, 0.8669536710,
      0.6759966016, 0.4459141195, 0.6715702415, 0.4603685141,
      0.7800032496, 0.1134440824, 0.5081574321, 0.8714895248,
      0.9275292754, 0.2203363329, 0.2519302964, 0.9040125012,
      0.3455173373, 0.0568725727, 0.7148866653, 0.4144188464,
      0.7353242040, 0.4770916402, 0.5005655289, 0.4175619185,
      0.2904849052, 0.9007108808, 0.6687875986, 0.7888323665,
      0.8957395554, 0.2501889467, 0.9198206067, 0.8626050949,
      0.5060852766, 0.5679021478, 0.1149322391, 0.7621158361,
      0.1732250005, 0.5338360667, 0.1264373064, 0.0729170963,
      0.6090274453, 0.4912031293, 0.6748099327, 0.7908541560,
      0.9826874733, 0.0840806812, 0.6312121153, 0.5769748688,
      0.6506421566, 0.5431794524, 0.5573673844, 0.8685546517,
      0.4520116150, 0.5349755883, 0.6909636855, 0.0894949883,
      0.4319253266, 0.1021342203, 0.1378098875, 0.0021255584,
      0.2097064406, 0.2166372687, 0.5162444711, 0.5702082515,
      0.8239611983, 0.4867111742, 0.8914545774, 0.3950607777,
      0.7446114421, 0.5527572632, 0.6238250732, 0.2703920007,
      0.9375950098, 0.7696546912, 0.1455950290, 0.5374343991,
      0.9957863092, 0.0490563326, 0.3028198481, 0.7408133745,
      0.0393614471, 0.7466710806, 0.5734212995, 0.7317056656,
      0.5508325696, 0.9394034743, 0.3464016914, 0.5744694471,
      0.0507799797, 0.5534328222, 0.4193929434, 0.9831618071,
      0.9456073046, 0.1382794082, 0.0416156426, 0.1206750646,
      0.1927469671, 0.7261679769, 0.5439779758, 0.5349253416,
      0.4645369649, 0.0066942186, 0.3924719095, 0.9989384413,
      0.8202912211, 0.5728607178, 0.1964629591, 0.9204694033,
      0.4241472483, 0.6193272471, 0.2031076550, 0.3280657530,
      0.3449534774, 0.3947518766, 0.0222318862, 0.6603470445,
      0.1699900180, 0.6033002734, 0.6195803285, 0.6979047656,
      0.2919311821, 0.2920319736, 0.7555294633, 0.3882241845,
      0.1524632573, 0.9052649140, 0.0130828097, 0.8864843845,
      0.2922567725, 0.3818250299, 0.9784051776, 0.4366757274,
      0.7158820033, 0.4123827815, 0.9135358334, 0.7194905281,
      0.4806917906, 0.0842216462, 0.3636338711, 0.4906066954,
      0.2838641703, 0.5346404910, 0.2096510679, 0.4943295717,
      0.5280051827, 0.6733596325, 0.7453658581, 0.7299737334,
      0.4241158962, 0.4559523165, 0.8735070825, 0.3627879322,
      0.7380328178, 0.9940672517, 0.9248083830, 0.5492368937,
      0.3051113784, 0.6223126650, 0.6843016744, 0.5269622803,
      0.3414766192, 0.4554265738, 0.0817907453, 0.2912822068,
      0.1448967606, 0.6664807200, 0.9592341185, 0.1572346836,
      0.0282940716, 0.7413571477, 0.3541644812, 0.5059663057,
      0.0610480756, 0.1777649522, 0.6955062747, 0.6052106023,
      0.8534111977, 0.9629232287, 0.3596150875, 0.6202484965,
      0.4476774037, 0.5055969357, 0.3915017545, 0.9773942232,
      0.6236377954, 0.1418854296, 0.6977284551, 0.9657562375,
      0.8948493600, 0.5580040812, 0.0147147840, 0.8055463433,
      0.9318613410, 0.7339289784, 0.4289531410, 0.3808411062,
      0.7446047664, 0.1078510955, 0.7846958637, 0.4988052249,
      0.0701190159, 0.8230451941, 0.3917074800, 0.1067649350,
      0.1737984419, 0.8594326377, 0.1727418005, 0.7842504382,
      0.8041161299, 0.0865181461, 0.4353865683, 0.7871589661,
      0.4900608957, 0.8660157919, 0.3797212541, 0.6283144355,
      0.2135202587, 0.8422563672, 0.8393572569, 0.5658343434,
      0.3230884373, 0.3475681841, 0.5946827531, 0.1284090728))).resize(1, 4, 10, 12)


    val expectedGradInput = Tensor(Storage(Array(
      1.6788704395, 1.6927247047, 1.9362056255, 1.3262131214,
      1.4246634245, 0.9634065628, 1.9182552099, 1.4203282595,
      1.8726528883, 2.1487400532, 2.6617891788, 1.5344431400,
      1.6121160984, 1.4390904903, 1.2788704634, 1.2924103737,
      2.3150115013, 2.1796765327, 2.0451989174, 1.7060029507,
      1.7903716564, 1.7707831860, 2.1560373306, 2.1786298752,
      1.9953336716, 1.5173866749, 1.4146933556, 2.3119082451,
      2.0380644798, 1.0565959215, 1.7915321589, 1.6547492743,
      2.0007340908, 1.6774380207, 1.2444193363, 1.4820042849,
      2.3108632565, 1.8435909748, 2.3198912144, 1.8867371082,
      2.2865357399, 2.0808281898, 2.3715317249, 2.2501168251,
      2.1690959930, 1.5059767962, 2.0148220062, 1.4546324015,
      1.9092568159, 1.8958400488, 1.7806823254, 1.7714538574,
      1.4736194611, 0.9920587540, 1.1222752333, 0.9864315391,
      1.4066356421, 1.8621717691, 1.9449006319, 1.0249991417,
      1.7271723747, 1.5925958157, 1.3687601089, 1.5787647963,
      2.0113990307, 1.9382460117, 1.8679108620, 2.1407086849,
      2.1620366573, 2.2863376141, 2.0543873310, 2.2410430908,
      1.7114396095, 1.7155170441, 1.8521229029, 1.9694323540,
      2.2654256821, 2.0773351192, 1.5956746340, 1.5178824663,
      2.0168771744, 2.0855758190, 2.2145228386, 1.8885054588,
      1.4493947029, 1.3915846348, 2.0280234814, 1.7721976042,
      1.2135972977, 1.8753764629, 1.5591725111, 2.0580890179,
      1.6945612431, 1.5683016777, 1.3255987167, 1.2991443872,
      1.6286255121, 2.2576007843, 2.2473452091, 2.6512677670,
      1.7274127007, 1.6008721590, 2.3135757446, 2.3013291359,
      1.8264909983, 2.1687846184, 1.4354686737, 1.6413037777,
      2.3131406307, 1.9649353027, 2.2818675041, 2.2093024254,
      1.8058276176, 2.1941344738, 1.6831705570, 1.4836474657,
      1.8921546936, 2.1033906937, 1.5571866035, 1.4232093096))).resize(1, 4, 5, 6)
    val output = conv.forward(input)
    output.size() should be(expectedOutput.size())
    (output.storage().array() zip expectedOutput.storage().array()).
      foreach(x => assert(Math.abs(x._1 - x._2) < 1e-6))
    val gradInput = conv.backward(input, gradOutput)

    gradInput.size() should be(expectedGradInput.size())
    (gradInput.storage().array() zip expectedGradInput.storage().array()).
      foreach(x => assert(Math.abs(x._1 - x._2) < 1e-6))
  }
}
