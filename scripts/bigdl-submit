#!/bin/bash

set -e

# usage
usage() { echo "Usage: $0 [-a|--archives <string#string> -h|--help]" 1>&2; exit 1; }

cmd=$@
# get options
set +e
ARGS=`getopt -q -o a:h --long archives:,help -- "$@"`
set -e
eval set -- "$ARGS"

# extract options and their arguments into variables.
archive-array=()
dir-array=()
dir=$PYSPARK_PYTHON
deploy-mode=""
while true ; do
    case "$1" in
        -a|--archives)
            archives=(${2//,/ })
            for archive in $archives
            do
                array=(${archive//#/ })
                archive-array[${#archive-array[@]}]=${array[0]}
                dir-array[${dir-array[@]}]=${array[1]}
            done
            shift 2
            ;;
        -d|--deploy-mode)
            deploy-mode=$2
            shift 2
            ;;
        -c|--conf)
            echo $deploy-mode
            if [ $2 =~ "spark.pyspark.driver.python" -o $2 =~ "spark.yarn.appMasterEnv.PYSPARK_PYTHON" -o $2 =~ "spark.executorEnv.PYSPARK_PYTHON"  ]
            then
                array=(${2//=/ })
                dir=${array[1]}
            fi
            shift 2
            ;;
        -h|--help)
            usage ; break ;;
        --)
              shift
              break
              ;;
    esac
done

echo $archive-array
echo $dir-array
echo $dir
echo $deploy-mode
exit 1
# check if environment exists
if [ ! -d "${dir}" ]
then
    # extract environment
    echo "extracting ${archives} to ${dir} ..."
    mkdir -p ${dir}
    set +e
    which "pv" >/dev/null 2>&1
    if [ $? -eq 0 ]
    then
        echo "extracting with progress bar..."
        pv ${archives}|tar -xz -C ${dir}
    else
        echo "extracting without progress bar...please install pv if you need progress bar."
        tar -xzf ${archives} -C ${dir}
    fi
    set -e
fi


# activate environment
source ${dir}/bin/activate

# detect paths
export BIGDL_ENV=`python -c """from bigdl.dllib.utils.engine import *
print(' ' + get_bigdl_conf(), end=' ')
bigdl_jars = get_bigdl_jars()
print(','.join(bigdl_jars), end=' ')
"""
`

# setup env
IFS=$' ' array=($(echo $BIGDL_ENV))
len=${#array[@]}
export BIGDL_CONF="${array[$len-2]}"
export BIGDL_JARS="${array[$len-1]}"

# check env
if [ -z ${BIGDL_CONF} ]; then
    echo "Cannot find BigDL configuration file, please check your BigDL installation"
    exit 1
fi

if [ -z $BIGDL_JARS ]; then
    echo "Cannot find BigDL jar files, please check your BigDL installation"
    exit 1
fi

spark-submit \
  --properties-file ${BIGDL_CONF} \
  --jars ${BIGDL_JARS} \
  --conf spark.driver.extraClassPath=${BIGDL_JARS} \
  --conf spark.executor.extraClassPath=${BIGDL_JARS} \
  ${cmd}
